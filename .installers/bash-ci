#!/usr/bin/env bash
# Installer script generated by Architect
# Downloads and installs the specified release asset from GitHub into CI PATH.

set -euo pipefail

REPO="architect-platform/architect"
NAME="architect-engine"
ASSET_TYPE="jar"
APPLICATION_NAME="architect-engine"
PREFIX="architect-engine"

BIN_DIR="$HOME/.local/bin"
mkdir -p "$BIN_DIR"

ASSET_NAME="${NAME}.${ASSET_TYPE}"
ASSET_PATH="${BIN_DIR}/${ASSET_NAME}"
EXECUTABLE_PATH="${BIN_DIR}/${APPLICATION_NAME}"

echo "🔍 Searching release for prefix '${PREFIX}' in ${REPO}..."

RELEASE_URL=$(curl -s "https://api.github.com/repos/${REPO}/releases" \
  | jq -r "[.[] | select(.tag_name | startswith(\"${PREFIX}\"))][0].url")

if [[ -z "${RELEASE_URL}" || "${RELEASE_URL}" == "null" ]]; then
  echo "❌ No release found for ${APPLICATION_NAME} in ${REPO}"
  exit 1
fi

# Fetch matching release metadata
ASSET_URL=$(curl -s "${RELEASE_URL}" \
  | jq -r ".assets[] | select(.name == \"${ASSET_NAME}\") | .browser_download_url")

if [[ -z "${ASSET_URL}" || "${ASSET_URL}" == "null" ]]; then
  echo "❌ Asset '${ASSET_NAME}' not found in release ${RELEASE_URL}"
  exit 1
fi

echo "⬇️ Downloading ${ASSET_NAME} from ${ASSET_URL}..."
curl -fsSL -o "${ASSET_PATH}" "${ASSET_URL}"

if [[ ! -s "${ASSET_PATH}" ]]; then
  echo "❌ Download failed or empty file: ${ASSET_PATH}"
  exit 1
fi

echo "⚙️ Creating executable wrapper for ${APPLICATION_NAME} in ${EXECUTABLE_PATH}..."

cat > "${EXECUTABLE_PATH}" <<'EOF'
#!/usr/bin/env bash
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
EOF

echo "exec java -jar \"\${DIR}/${ASSET_NAME}\" \"\$@\"" >> "${EXECUTABLE_PATH}"

chmod +x "${ASSET_PATH}" "${EXECUTABLE_PATH}"

# Add to PATH for GitHub Actions
if [[ -n "${GITHUB_PATH:-}" ]]; then
  echo "${BIN_DIR}" >> "${GITHUB_PATH}"
fi

echo "✅ ${APPLICATION_NAME} installed successfully!"
echo "   Binary: ${EXECUTABLE_PATH}"
echo "   Asset:  ${ASSET_PATH}"
echo "   Release tag: $(basename "${RELEASE_URL}")"
