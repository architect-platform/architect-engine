#!/usr/bin/env bash
set -e

# Installer script for monorepo-based releases

REPO="architect-platform/architect-engine"
NAME="architect-engine"
ASSET_TYPE="jar"
APPLICATION_NAME="architect-engine"
PREFIX="architect-engine"
ASSET_NAME="${NAME}.${ASSET_TYPE}"

INSTALL_DIR="$HOME/.${NAME}"
BIN_PATH="$INSTALL_DIR/$APPLICATION_NAME"
FINAL_ASSET="$INSTALL_DIR/$ASSET_NAME"

echo "ðŸ“¦ Installing $NAME from $REPO"
mkdir -p "$INSTALL_DIR"

cat <<'EOF' > "$BIN_PATH"
#!/bin/bash
DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
EOF

echo "exec java -jar $FINAL_ASSET \"\$@\"" >> "$BIN_PATH"
chmod +x "$BIN_PATH"

if [ "$2" == "local" ]; then
  echo "Building $APPLICATION_NAME"
  ./gradlew ":$NAME:build"
  cp "$NAME/build/libs/$ASSET_NAME" "$FINAL_ASSET"
  exit 0
else
  # --- 1ï¸âƒ£ Get the latest tag matching the subproject prefix ---
  echo "Fetching latest releases for prefix '$PREFIX'..."
  TAG=$(curl -s "https://api.github.com/repos/$REPO/releases" | \
        jq -r ".[].name" | grep "^${PREFIX}" | sort -Vr | head -n 1)

  if [ -z "$TAG" ]; then
      echo "âŒ No release tag found for prefix '$PREFIX'."
      exit 1
  fi
  echo "Found latest releases: $TAG"

  # --- 2ï¸âƒ£ Get the release info for that tag ---
  RELEASE_URL="https://api.github.com/repos/$REPO/releases/tags/$TAG"
  ASSET_URL=$(curl -s "$RELEASE_URL" | jq -r ".assets[] | select(.name == \"$ASSET_NAME\") | .browser_download_url")

  if [[ -z "$ASSET_URL" || "$ASSET_URL" == "null" ]]; then
      echo "âŒ Asset '$ASSET_NAME' not found for tag '$TAG'."
      exit 1
  fi

  # --- 3ï¸âƒ£ Download the correct asset ---
  echo "â¬‡ï¸  Downloading $ASSET_NAME from $ASSET_URL..."
  curl -sL "$ASSET_URL" -o "$FINAL_ASSET"
  echo "âœ… Download complete"
fi

# --- 4ï¸âƒ£ Add to PATH if needed ---
SHELL_NAME=$(basename "$SHELL")
PROFILE="$HOME/.profile"
[[ "$SHELL_NAME" == "bash" ]] && PROFILE="$HOME/.bashrc"
[[ "$SHELL_NAME" == "zsh" ]] && PROFILE="$HOME/.zshrc"

if ! grep -qs "export PATH=\"$HOME/.$NAME:\$PATH\"" "$PROFILE"; then
  echo "export PATH=\"$HOME/.$NAME:\$PATH\"" >> "$PROFILE"
  echo "âœ… Added $INSTALL_DIR to PATH in $PROFILE"
  source "$PROFILE"
fi

echo "ðŸš€ Installed $NAME successfully â€” run with: $APPLICATION_NAME"
